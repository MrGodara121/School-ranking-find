<!-- Lead Generation Form Component -->
<div class="lead-form-container">
    <div class="lead-form-card">
        <div class="lead-form-header">
            <h3 class="lead-form-title">Get Personalized School Recommendations</h3>
            <p class="lead-form-subtitle">Tell us what you're looking for and we'll help you find the perfect school</p>
        </div>
        
        <!-- Success Message (hidden by default) -->
        <div class="lead-success" id="lead-success" style="display: none;">
            <div class="success-icon">âœ“</div>
            <h4>Thank You!</h4>
            <p>We've received your request and will send personalized recommendations to your email within 24 hours.</p>
        </div>
        
        <!-- Lead Form -->
        <form class="lead-form" id="lead-form" method="POST">
            <!-- Honeypot field (hidden from real users) -->
            <div class="honeypot-field">
                <label>Leave this empty: <input type="text" name="website" id="honeypot" autocomplete="off" tabindex="-1"></label>
            </div>
            
            <!-- School ID (hidden) -->
            <input type="hidden" name="school_id" id="lead-school-id" value="[SCHOOL_ID]">
            
            <!-- Parent Name -->
            <div class="form-group">
                <label for="lead-name" class="required-field">Parent/Guardian Name <span class="required-star">*</span></label>
                <input type="text" 
                       class="form-control" 
                       id="lead-name" 
                       name="name" 
                       placeholder="Enter your full name"
                       required
                       minlength="2"
                       maxlength="100"
                       pattern="[A-Za-z\s]+"
                       title="Please enter a valid name (letters and spaces only)">
                <div class="form-error" id="lead-name-error"></div>
            </div>
            
            <!-- Email Address -->
            <div class="form-group">
                <label for="lead-email" class="required-field">Email Address <span class="required-star">*</span></label>
                <input type="email" 
                       class="form-control" 
                       id="lead-email" 
                       name="email" 
                       placeholder="your@email.com"
                       required
                       pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                       title="Please enter a valid email address">
                <div class="form-error" id="lead-email-error"></div>
                <small class="form-hint">We'll send recommendations to this email</small>
            </div>
            
            <!-- Phone Number (Optional) -->
            <div class="form-group">
                <label for="lead-phone">Phone Number <span class="optional-badge">Optional</span></label>
                <input type="tel" 
                       class="form-control" 
                       id="lead-phone" 
                       name="phone" 
                       placeholder="(555) 123-4567"
                       pattern="[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}"
                       title="Please enter a valid phone number">
                <div class="form-error" id="lead-phone-error"></div>
            </div>
            
            <!-- Child's Grade/Interests -->
            <div class="form-group">
                <label for="lead-grade">Child's Grade Level <span class="optional-badge">Optional</span></label>
                <select class="form-control" id="lead-grade" name="grade_level">
                    <option value="">Select grade level...</option>
                    <option value="prek">Pre-K</option>
                    <option value="k">Kindergarten</option>
                    <option value="1">1st Grade</option>
                    <option value="2">2nd Grade</option>
                    <option value="3">3rd Grade</option>
                    <option value="4">4th Grade</option>
                    <option value="5">5th Grade</option>
                    <option value="6">6th Grade</option>
                    <option value="7">7th Grade</option>
                    <option value="8">8th Grade</option>
                    <option value="9">9th Grade</option>
                    <option value="10">10th Grade</option>
                    <option value="11">11th Grade</option>
                    <option value="12">12th Grade</option>
                </select>
            </div>
            
            <!-- Preferences -->
            <div class="form-group">
                <label for="lead-preferences">What are you looking for? <span class="optional-badge">Optional</span></label>
                <textarea class="form-control" 
                          id="lead-preferences" 
                          name="preferences" 
                          rows="3"
                          placeholder="e.g., Strong math program, small class sizes, extracurricular activities..."></textarea>
            </div>
            
            <!-- How did you hear about us? -->
            <div class="form-group">
                <label for="lead-source">How did you hear about us? <span class="optional-badge">Optional</span></label>
                <select class="form-control" id="lead-source" name="source">
                    <option value="">Select option...</option>
                    <option value="search">Search Engine (Google/Bing)</option>
                    <option value="social">Social Media</option>
                    <option value="friend">Friend/Family</option>
                    <option value="ad">Advertisement</option>
                    <option value="blog">Blog/Article</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <!-- Consent Checkboxes -->
            <div class="form-group consent-group">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="consent-email" name="consent_email" checked required>
                    <label for="consent-email">
                        I agree to receive email communications from [SITE_NAME] <span class="required-star">*</span>
                    </label>
                </div>
                
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="consent-privacy" name="consent_privacy" checked required>
                    <label for="consent-privacy">
                        I agree to the <a href="/privacy.html" target="_blank">Privacy Policy</a> and <a href="/terms.html" target="_blank">Terms of Service</a> <span class="required-star">*</span>
                    </label>
                </div>
                
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="consent-sms" name="consent_sms">
                    <label for="consent-sms">
                        I'd like to receive SMS updates (optional)
                    </label>
                </div>
            </div>
            
            <!-- reCAPTCHA -->
            <div class="form-group recaptcha-group">
                <div class="g-recaptcha" data-sitekey="[RECAPTCHA_KEY]"></div>
                <div class="form-error" id="lead-recaptcha-error"></div>
            </div>
            
            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary btn-block" id="lead-submit">
                <span class="btn-text">Get Recommendations</span>
                <span class="btn-loader" style="display: none;">
                    <svg class="spinner" width="20" height="20" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="32" stroke-dashoffset="32">
                            <animate attributeName="stroke-dashoffset" dur="1.5s" values="32;0" repeatCount="indefinite"/>
                        </circle>
                    </svg>
                    Sending...
                </span>
            </button>
            
            <!-- Privacy Note -->
            <p class="privacy-note">
                We respect your privacy. Unsubscribe at any time.
            </p>
        </form>
    </div>
</div>

<!-- Mini Lead Form (for sidebars) -->
<div class="lead-form-mini" id="lead-form-mini-template" style="display: none;">
    <div class="mini-form-card">
        <h4>Get School Updates</h4>
        <form class="mini-form" id="mini-lead-form">
            <div class="honeypot-field">
                <input type="text" name="website" tabindex="-1">
            </div>
            <input type="hidden" name="school_id" class="mini-school-id">
            
            <div class="mini-form-group">
                <input type="email" name="email" class="mini-input" placeholder="Your email address" required>
            </div>
            
            <button type="submit" class="btn-mini-submit">Subscribe</button>
        </form>
        <p class="mini-note">Get updates about this school</p>
    </div>
</div>

<!-- JavaScript for Lead Form -->
<script>
(function() {
    class LeadForm {
        constructor(formId = 'lead-form') {
            this.form = document.getElementById(formId);
            if (!this.form) return;
            
            this.submitBtn = document.getElementById('lead-submit');
            this.successDiv = document.getElementById('lead-success');
            this.honeypot = document.getElementById('honeypot');
            
            this.init();
        }
        
        init() {
            this.form.addEventListener('submit', this.handleSubmit.bind(this));
            
            // Real-time validation
            const emailInput = document.getElementById('lead-email');
            if (emailInput) {
                emailInput.addEventListener('blur', () => this.validateEmail());
            }
            
            const phoneInput = document.getElementById('lead-phone');
            if (phoneInput) {
                phoneInput.addEventListener('blur', () => this.validatePhone());
            }
        }
        
        handleSubmit(e) {
            e.preventDefault();
            
            // Clear previous errors
            this.clearErrors();
            
            // Honeypot check
            if (this.honeypot && this.honeypot.value) {
                console.log('Bot detected');
                this.showSuccess(); // Silently succeed for bots
                return;
            }
            
            // Rate limiting check
            if (!Utils.checkRateLimit('leads')) {
                alert('Please wait a moment before submitting another form.');
                return;
            }
            
            // Validate form
            if (!this.validateForm()) {
                return;
            }
            
            // Show loading
            this.setLoading(true);
            
            // Collect form data
            const formData = new FormData(this.form);
            const data = {
                lead_id: Utils.generateId(),
                school_id: formData.get('school_id') || null,
                parent_name: formData.get('name'),
                email: formData.get('email'),
                phone: formData.get('phone') || null,
                grade_level: formData.get('grade_level') || null,
                preferences: formData.get('preferences') || null,
                source: formData.get('source') || null,
                consent_email: formData.get('consent_email') === 'on',
                consent_sms: formData.get('consent_sms') === 'on',
                consent_privacy: formData.get('consent_privacy') === 'on',
                ip_address: '', // Will be captured server-side
                user_agent: navigator.userAgent,
                page_url: window.location.href,
                referrer: document.referrer || 'direct',
                submission_time: new Date().toISOString(),
                validation_status: 'pending',
                intent_level: this.calculateIntent(formData),
                score: 0,
                duplicate_flag: false
            };
            
            // Submit to server
            this.submitLead(data);
        }
        
        validateForm() {
            let isValid = true;
            
            // Validate name
            const name = document.getElementById('lead-name').value.trim();
            if (!name || name.length < 2) {
                this.showError('lead-name', 'Please enter your full name');
                isValid = false;
            }
            
            // Validate email
            if (!this.validateEmail()) {
                isValid = false;
            }
            
            // Validate phone if provided
            const phone = document.getElementById('lead-phone').value;
            if (phone && !this.validatePhone()) {
                isValid = false;
            }
            
            // Validate consents
            const consentEmail = document.getElementById('consent-email');
            const consentPrivacy = document.getElementById('consent-privacy');
            
            if (!consentEmail.checked) {
                alert('Please agree to receive email communications');
                isValid = false;
            }
            
            if (!consentPrivacy.checked) {
                alert('Please agree to the Privacy Policy and Terms of Service');
                isValid = false;
            }
            
            // Validate reCAPTCHA
            const recaptchaResponse = grecaptcha.getResponse();
            if (!recaptchaResponse) {
                this.showError('lead-recaptcha', 'Please complete the reCAPTCHA verification');
                isValid = false;
            }
            
            return isValid;
        }
        
        validateEmail() {
            const email = document.getElementById('lead-email').value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!email || !emailRegex.test(email)) {
                this.showError('lead-email', 'Please enter a valid email address');
                return false;
            }
            
            // Check blocked domains
            if (CONFIG.BLOCKED_EMAIL_DOMAINS) {
                const domain = email.split('@')[1];
                if (CONFIG.BLOCKED_EMAIL_DOMAINS.includes(domain)) {
                    this.showError('lead-email', 'Please use a permanent email address');
                    return false;
                }
            }
            
            return true;
        }
        
        validatePhone() {
            const phone = document.getElementById('lead-phone').value.trim();
            if (!phone) return true; // Phone is optional
            
            const phoneRegex = /^[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}$/;
            if (!phoneRegex.test(phone)) {
                this.showError('lead-phone', 'Please enter a valid phone number');
                return false;
            }
            
            return true;
        }
        
        calculateIntent(formData) {
            let score = 0;
            
            if (formData.get('name')) score += 10;
            if (formData.get('email')) score += 20;
            if (formData.get('phone')) score += 15;
            if (formData.get('grade_level')) score += 15;
            if (formData.get('preferences') && formData.get('preferences').length > 20) score += 25;
            if (formData.get('source')) score += 15;
            
            return score;
        }
        
        submitLead(data) {
            fetch(`${CONFIG.API_BASE}?action=submitLead`, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(() => {
                this.showSuccess();
                this.form.reset();
                grecaptcha.reset();
                Utils.updateRateLimit('leads');
                
                // Track in analytics
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'lead_submit', {
                        'event_category': 'conversion',
                        'event_label': data.school_id ? 'school_page' : 'general'
                    });
                }
            })
            .catch(error => {
                console.error('Error submitting lead:', error);
                alert('An error occurred. Please try again or email us directly.');
                
                // Track error
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'lead_error', {
                        'event_category': 'error',
                        'event_label': error.message
                    });
                }
            })
            .finally(() => {
                this.setLoading(false);
            });
        }
        
        showError(fieldId, message) {
            const errorDiv = document.getElementById(`${fieldId}-error`);
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
            
            const input = document.getElementById(fieldId);
            if (input) {
                input.classList.add('error');
            }
        }
        
        clearErrors() {
            document.querySelectorAll('.form-error').forEach(el => {
                el.textContent = '';
                el.style.display = 'none';
            });
            
            document.querySelectorAll('.form-control').forEach(el => {
                el.classList.remove('error');
            });
        }
        
        showSuccess() {
            if (this.successDiv) {
                this.form.style.display = 'none';
                this.successDiv.style.display = 'block';
            }
        }
        
        setLoading(isLoading) {
            if (!this.submitBtn) return;
            
            const btnText = this.submitBtn.querySelector('.btn-text');
            const btnLoader = this.submitBtn.querySelector('.btn-loader');
            
            this.submitBtn.disabled = isLoading;
            
            if (isLoading) {
                btnText.style.display = 'none';
                btnLoader.style.display = 'inline-flex';
            } else {
                btnText.style.display = 'inline';
                btnLoader.style.display = 'none';
            }
        }
    }
    
    // Initialize lead form
    document.addEventListener('DOMContentLoaded', () => {
        window.leadForm = new LeadForm('lead-form');
    });
})();
</script>

<!-- CSS for Lead Form -->
<style>
.lead-form-container {
    max-width: 600px;
    margin: 0 auto;
}

.lead-form-card {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    border: 1px solid #e9ecef;
}

.lead-form-header {
    text-align: center;
    margin-bottom: 2rem;
}

.lead-form-title {
    margin: 0 0 0.5rem 0;
    font-size: 1.5rem;
    color: var(--dark, #2d3436);
}

.lead-form-subtitle {
    margin: 0;
    color: var(--gray, #636e72);
    font-size: 0.95rem;
}

/* Form Groups */
.form-group {
    margin-bottom: 1.25rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--dark, #2d3436);
    font-size: 0.95rem;
}

.required-field .required-star {
    color: #e74c3c;
}

.optional-badge {
    font-size: 0.7rem;
    background: var(--light-gray, #f8f9fa);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    color: var(--gray, #636e72);
    font-weight: normal;
    margin-left: 0.5rem;
    text-transform: uppercase;
}

.form-control {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: white;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color, #2563eb);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.form-control.error {
    border-color: #e74c3c;
}

.form-error {
    color: #e74c3c;
    font-size: 0.8rem;
    margin-top: 0.25rem;
    display: none;
}

.form-hint {
    display: block;
    color: var(--gray, #636e72);
    font-size: 0.8rem;
    margin-top: 0.25rem;
}

/* Consent Group */
.consent-group {
    background: var(--light-gray, #f8f9fa);
    padding: 1rem;
    border-radius: 8px;
    margin: 1.5rem 0;
}

.checkbox-wrapper {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
}

.checkbox-wrapper:last-child {
    margin-bottom: 0;
}

.checkbox-wrapper input[type="checkbox"] {
    margin-top: 0.2rem;
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.checkbox-wrapper label {
    font-size: 0.9rem;
    color: var(--gray, #636e72);
    line-height: 1.4;
    margin-bottom: 0;
    cursor: pointer;
    flex: 1;
}

.checkbox-wrapper a {
    color: var(--primary-color, #2563eb);
    text-decoration: none;
}

.checkbox-wrapper a:hover {
    text-decoration: underline;
}

/* Honeypot */
.honeypot-field {
    display: none;
}

/* reCAPTCHA */
.recaptcha-group {
    margin: 1.5rem 0;
}

/* Submit Button */
.btn-block {
    width: 100%;
    padding: 1rem;
    font-size: 1.1rem;
    margin-top: 0.5rem;
}

.btn-loader {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Privacy Note */
.privacy-note {
    text-align: center;
    font-size: 0.8rem;
    color: var(--gray, #636e72);
    margin-top: 1rem;
}

/* Success Message */
.lead-success {
    text-align: center;
    padding: 2rem;
}

.success-icon {
    width: 60px;
    height: 60px;
    background: #27ae60;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    margin: 0 auto 1rem auto;
}

.lead-success h4 {
    margin: 0 0 0.5rem 0;
    color: var(--dark, #2d3436);
    font-size: 1.25rem;
}

.lead-success p {
    margin: 0;
    color: var(--gray, #636e72);
}

/* Mini Lead Form */
.lead-form-mini {
    max-width: 300px;
}

.mini-form-card {
    background: white;
    border-radius: 12px;
    padding: 1.25rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
}

.mini-form-card h4 {
    margin: 0 0 1rem 0;
    font-size: 1.1rem;
    color: var(--dark, #2d3436);
}

.mini-form-group {
    margin-bottom: 0.75rem;
}

.mini-input {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    font-size: 0.9rem;
}

.mini-input:focus {
    outline: none;
    border-color: var(--primary-color, #2563eb);
}

.btn-mini-submit {
    width: 100%;
    background: var(--primary-color, #2563eb);
    color: white;
    border: none;
    padding: 0.5rem;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s ease;
}

.btn-mini-submit:hover {
    background: var(--secondary-color, #1e40af);
}

.mini-note {
    text-align: center;
    font-size: 0.7rem;
    color: var(--gray, #636e72);
    margin: 0.5rem 0 0 0;
}

/* Responsive */
@media (max-width: 768px) {
    .lead-form-card {
        padding: 1.5rem;
    }
    
    .lead-form-title {
        font-size: 1.25rem;
    }
}
</style>
